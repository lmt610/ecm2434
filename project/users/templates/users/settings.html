{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ExePLORE - Settings</title>
    <link rel="stylesheet" href="{% static 'race/race_styles.css' %}">
    <link rel="stylesheet" href="{% static 'users/settings_styles.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <header>
        <img src="{% static 'race/images/UniversityOfExeterLogo.png' %}" alt="Exeter University Logo">
        <p id="pageTitle">ExePLORE</p>
    </header>

    <div class="settings-wrapper">
        <!-- Settings Navigation -->
        <nav class="settings-nav">
            <div class="nav-item active" data-tab="account">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                Account
            </div>
            <div class="nav-item" data-tab="privacy">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                Privacy
            </div>
            <div class="nav-item" data-tab="notifications">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                Notifications
            </div>
            <div class="nav-item" data-tab="about">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                About
            </div>
        </nav>

        <!-- Settings Content -->
        <main class="settings-content">
            <!-- Account Tab -->
            <div class="settings-tab active" id="account">
                <div class="settings-header">
                    <h1>Account Settings</h1>
                    <p>Manage your account settings and preferences</p>
                </div>

                <div class="settings-card">
                    <div class="card-header">
                        <h2>Profile Information</h2>
                    </div>
                    <div class="card-content">
                        <div class="form-group">
                            <label>Username</label>
                            <input type="text" value="{{ user.username }}" disabled>
                        </div>
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" value="{{ user.email }}" disabled>
                            <button class="btn-secondary">Change Email</button>
                        </div>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="card-header">
                        <h2>Security</h2>
                    </div>
                    <div class="card-content">
                        <button type="button" class="btn-primary">Change Password</button>
                    </div>
                </div>

                <div class="settings-card danger-zone">
                    <div class="card-header">
                        <h2>Danger Zone</h2>
                    </div>
                    <div class="card-content">
                        <p class="warning-text">Once you delete your account, there is no going back. Please be certain.</p>
                        <button class="btn-danger">Delete Account</button>
                    </div>
                </div>
            </div>

            <!-- Privacy Tab -->
            <div class="settings-tab" id="privacy">
                <div class="settings-header">
                    <h1>Privacy Settings</h1>
                    <p>Control your privacy and location settings</p>
                </div>

                <div class="settings-card">
                    <div class="card-header">
                        <h2>Location Services</h2>
                    </div>
                    <div class="card-content">
                        <div class="setting-toggle">
                            <span>Allow location tracking while using the app</span>
                            <label class="switch">
                                <input type="checkbox" 
                                       name="location_tracking" 
                                       {% if settings.location_tracking %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <p class="setting-description">Required for tracking your routes and calculating completion times</p>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="card-header">
                        <h2>Activity Visibility</h2>
                    </div>
                    <div class="card-content">
                        <div class="setting-toggle">
                            <span>Show my activities on leaderboards</span>
                            <label class="switch">
                                <input type="checkbox" 
                                       name="show_on_leaderboard" 
                                       {% if settings.show_on_leaderboard %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Tab -->
            <div class="settings-tab" id="notifications">
                <div class="settings-header">
                    <h1>Notification Settings</h1>
                    <p>Manage your notification preferences</p>
                </div>

                <div class="settings-card">
                    <div class="card-header">
                        <h2>Route Notifications</h2>
                    </div>
                    <div class="card-content">
                        <div class="setting-toggle">
                            <span>New route alerts</span>
                            <label class="switch">
                                <input type="checkbox" 
                                       name="route_notifications" 
                                       {% if settings.route_notifications %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                        <div class="setting-toggle">
                            <span>Achievement notifications</span>
                            <label class="switch">
                                <input type="checkbox" 
                                       name="achievement_notifications" 
                                       {% if settings.achievement_notifications %}checked{% endif %}>
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- About Tab -->
            <div class="settings-tab" id="about">
                <div class="settings-header">
                    <h1>About ExePLORE</h1>
                    <p>Information about the application and legal notices</p>
                </div>

                <div class="settings-card">
                    <div class="card-header">
                        <h2>Application Information</h2>
                    </div>
                    <div class="card-content">
                        <p>ExePLORE is a University of Exeter application designed to promote sustainability and green spaces by tracking walking routes across campus.</p>
                        <p>Version: 1.0.0</p>
                    </div>
                </div>

                <div class="settings-card">
                    <div class="card-header">
                        <h2>Legal Information</h2>
                    </div>
                    <div class="card-content">
                        <div class="legal-links">
                            <a href="#" class="text-link">Privacy Policy</a>
                            <a href="#" class="text-link">Terms of Service</a>
                            <a href="#" class="text-link">Data Protection</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete Account Modal -->
    <div id="deleteConfirmation" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Delete Account</h2>
                <button class="close-button">
            </div>
            <div class="modal-body">
                <div class="warning-icon">⚠️</div>
                <p>Are you sure you want to delete your account? This action cannot be undone.</p>
                <p>The following data will be permanently deleted:</p>
                <ul>
                    <li>Your profile and personal information</li>
                    <li>All activity history and achievements</li>
                    <li>Points and rankings</li>
                    <li>Saved routes and preferences</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary">Cancel</button>
                <form method="POST" action="{% url 'delete_account' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-danger">Delete Account</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Email Modal -->
    <div id="changeEmailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Email</h2>
                <button class="close-button">
            </div>
            <div class="modal-body">
                <form id="emailChangeForm" method="POST" action="{% url 'update_email' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="currentEmail">Current Email</label>
                        <input type="email" id="currentEmail" value="{{ user.email }}" disabled>
                    </div>
                    <div class="form-group">
                        <label for="newEmail">New Email</label>
                        <input type="email" id="newEmail" name="email" required>
                        <span class="field-hint">Please enter a valid email address</span>
                        <div id="emailError" class="error-message" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirmEmail">Confirm New Email</label>
                        <input type="email" id="confirmEmail" required>
                        <div id="confirmEmailError" class="error-message" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Update Email</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Change Password</h2>
                <button class="close-button">
            </div>
            <div class="modal-body">
                <form id="passwordChangeForm" method="POST" action="{% url 'change_password' %}">
                    {% csrf_token %}                
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="old_password" required>
                        <div id="currentPasswordError" class="error-message" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" name="new_password1" required>
                        <span class="field-hint">Must be at least 8 characters long and include numbers and letters</span>
                        <div id="newPasswordError" class="error-message" style="display: none;"></div>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" name="new_password2" required>
                        <div id="confirmPasswordError" class="error-message" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary">Cancel</button>
                        <button type="submit" class="btn-primary">Update Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        /*** Tab Switching ***/
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                // Update navigation items
                document.querySelectorAll('.nav-item').forEach(navItem => {
                    navItem.classList.remove('active');
                });
                item.classList.add('active');
        
                // Update content
                const tabId = item.getAttribute('data-tab');
                document.querySelectorAll('.settings-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            });
        });
        
        /*** CSRF Token Handling ***/
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }
        
        /*** Settings Toggle Functionality ***/
        document.querySelectorAll('.setting-toggle input[type="checkbox"]').forEach(toggle => {
            toggle.addEventListener('change', (e) => {
                const settingName = e.target.getAttribute('name');
                const value = e.target.checked;
                
                fetch('/toggle-setting/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': getCsrfToken(),
                    },
                    body: `setting=${settingName}&value=${value}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        console.log(`${settingName} updated successfully`);
                    } else {
                        e.target.checked = !value;
                        console.error('Failed to update setting');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    e.target.checked = !value;
                });
            });
        });
        
        /*** Delete Account Modal Functions ***/
        function showDeleteConfirmation() {
            const modal = document.getElementById('deleteConfirmation');
            modal.style.display = 'flex';
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
        }
        
        function hideDeleteConfirmation() {
            const modal = document.getElementById('deleteConfirmation');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }
        
        /*** Email Modal Functions ***/
        function showEmailModal() {
            const modal = document.getElementById('changeEmailModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            document.getElementById('newEmail').focus();
        }
        
        function hideEmailModal() {
            const modal = document.getElementById('changeEmailModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('emailChangeForm').reset();
                clearEmailErrors();
            }, 300);
        }
        
        function clearEmailErrors() {
            document.getElementById('emailError').style.display = 'none';
            document.getElementById('confirmEmailError').style.display = 'none';
        }
        
        function validateEmailForm() {
            clearEmailErrors();
            let isValid = true;
            const newEmail = document.getElementById('newEmail').value;
            const confirmEmail = document.getElementById('confirmEmail').value;
        
            if (!isValidEmail(newEmail)) {
                showEmailError('Please enter a valid email address');
                isValid = false;
            }
        
            if (newEmail !== confirmEmail) {
                showConfirmEmailError('Emails do not match');
                isValid = false;
            }
        
            return isValid;
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        function showEmailError(message) {
            const errorDiv = document.getElementById('emailError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function showConfirmEmailError(message) {
            const errorDiv = document.getElementById('confirmEmailError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        /*** Password Modal Functions ***/
        function showPasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
            document.getElementById('currentPassword').focus();
        }
        
        function hidePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.style.display = 'none';
                document.getElementById('passwordChangeForm').reset();
                clearPasswordErrors();
            }, 300);
        }
        
        function clearPasswordErrors() {
            // Clear existing error messages
            const errorDivs = document.querySelectorAll('.error-message');
            errorDivs.forEach(div => {
                div.style.display = 'none';
                div.textContent = '';
            });
        
            // Remove error class from inputs
            const inputs = document.querySelectorAll('#passwordChangeForm input');
            inputs.forEach(input => input.classList.remove('error'));
        
            // Remove any dynamic success messages
            const successMessages = document.querySelectorAll('.success-message');
            successMessages.forEach(msg => msg.remove());
        }
        
        function showFieldError(fieldId, message) {
            const errorDiv = document.getElementById(`${fieldId}Error`);
            const field = document.getElementById(fieldId);
            
            if (errorDiv && field) {
                field.classList.add('error');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function handleServerErrors(errors) {
            if (typeof errors === 'string') {
                // Handle single error message
                showFieldError('currentPassword', errors);
                return;
            }
        
            // Handle multiple error messages
            if (errors.old_password) {
                showFieldError('currentPassword', errors.old_password);
            }
            if (errors.new_password1) {
                showFieldError('newPassword', errors.new_password1);
            }
            if (errors.new_password2) {
                showFieldError('confirmPassword', errors.new_password2);
            }
        }
        
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const form = document.getElementById('passwordChangeForm');
            form.insertBefore(successDiv, form.firstChild);
        }
        
        function validateAndSubmitPasswordForm(event) {
            event.preventDefault();
            clearPasswordErrors();
        
            const form = event.target;
            const formData = new FormData(form);
        
            // Submit form
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCsrfToken()
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showSuccessMessage(data.message);
                    setTimeout(hidePasswordModal, 2000);
                } else {
                    handleServerErrors(data.errors);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showFieldError('currentPassword', 'An error occurred. Please try again.');
            });
        }
        
        /*** Global Modal Click-Outside Handler ***/
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                hideEmailModal();
                hidePasswordModal();
                hideDeleteConfirmation();
            }
        }
        
        /*** Initialize Event Listeners ***/
        document.addEventListener('DOMContentLoaded', function() {
            // Email change button
            const emailChangeButton = document.querySelector('.form-group .btn-secondary');
            if (emailChangeButton) {
                emailChangeButton.addEventListener('click', showEmailModal);
            }
        
            // Password change form
            const passwordForm = document.getElementById('passwordChangeForm');
            if (passwordForm) {
                // Remove any existing event listeners
                const newPasswordForm = passwordForm.cloneNode(true);
                passwordForm.parentNode.replaceChild(newPasswordForm, passwordForm);
                
                // Add the event listener
                newPasswordForm.addEventListener('submit', validateAndSubmitPasswordForm);
            }
        
            // Close buttons
            document.querySelectorAll('.close-button').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal.id === 'deleteConfirmation') hideDeleteConfirmation();
                    if (modal.id === 'changeEmailModal') hideEmailModal();
                    if (modal.id === 'changePasswordModal') hidePasswordModal();
                });
            });
        
            // Cancel buttons
            document.querySelectorAll('.modal .btn-secondary').forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    if (modal.id === 'deleteConfirmation') hideDeleteConfirmation();
                    if (modal.id === 'changeEmailModal') hideEmailModal();
                    if (modal.id === 'changePasswordModal') hidePasswordModal();
                });
            });
        
            // Show modal buttons
            const showDeleteButton = document.querySelector('.btn-danger');
            if (showDeleteButton) {
                showDeleteButton.addEventListener('click', showDeleteConfirmation);
            }
        
            const showPasswordButton = document.querySelector('.card-content .btn-primary');
            if (showPasswordButton) {
                showPasswordButton.addEventListener('click', showPasswordModal);
            }
        
            // Email form
            const emailForm = document.getElementById('emailChangeForm');
            if (emailForm) {
                emailForm.addEventListener('submit', function(e) {
                    if (!validateEmailForm()) {
                        e.preventDefault();
                    }
                });
            }
        });
        </script>
</body>
</html>