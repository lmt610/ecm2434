{% extends 'base.html' %}
{% load static %}

{% block title %}ExePLORE - Race Menu{% endblock %}

        <!-- Leaflet mapping plugin-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <!-- Font Awesome for map race icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>

<body>
    <header>
        <img src="{% static 'race/images/UniversityOfExeterLogo.png' %}" alt="Exeter University Logo">
        <p id="pageTitle">ExePLORE</p>
    </header>
    <main>
        <div class="menuBanner">Select Race!</div>
        <div class="raceMenu">
            <div class="row">
                {% for race in races %}
                <a class="raceOption" href="{% url 'race_detail' race.id %}">
                    <div class="raceOption">
                        {{ race.title }}
                    </div>
                    <div id="map-{{ race.id }}" class="map">
                        
                    </div>
                </a>
                {% if forloop.counter|divisibleby:2 and not forloop.last %}
                        </div><div class="row">
                {% endif %}
            </div>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <i class="fas fa-map-marked-alt"></i>
        <h2>No races available</h2>
        <p>There are no races set up yet. Check back later!</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    const races = [
        {% for race in races %}
            {
                id: "{{ race.id }}",
                start: { lat: {{ race.start.latitude }}, lng: {{ race.start.longitude }} },
                end: { lat: {{ race.end.latitude }}, lng: {{ race.end.longitude }} }
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    document.addEventListener('DOMContentLoaded', function() {
        if (races.length === 0) return;

        races.forEach(race => {
            const mapContainer = document.getElementById(`map-${race.id}`);
            if (!mapContainer) return;

            const map = L.map(`map-${race.id}`, {
                zoomControl: false,
                dragging: false,
                touchZoom: false,
                scrollWheelZoom: false
            }).setView([50.736577, -3.532512], 14.5);

            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                attribution: "&copy; OpenStreetMap contributors",
            }).addTo(map);

            const startIcon = L.divIcon({
                html: '<i class="fa fa-flag fa-2x" style="color: #40ff40;"></i>',
                iconSize: [25, 30],
                iconAnchor: [0, 30],
                className: 'start-flag-icon'
            });
            const endIcon = L.divIcon({
                html: '<i class="fa fa-flag-checkered fa-2x" style="color: #4040ff;"></i>',
                iconSize: [25, 30],
                iconAnchor: [0, 30],
                className: 'end-flag-icon'
            });

            L.marker([race.start.lat, race.start.lng], { icon: startIcon }).addTo(map);
            L.marker([race.end.lat, race.end.lng], { icon: endIcon }).addTo(map);

            const bounds = L.latLngBounds([
                [race.start.lat, race.start.lng],
                [race.end.lat, race.end.lng]
            ]);
            map.fitBounds(bounds, { padding: [30, 30] });
        });
    });
</script>
{% endblock %}