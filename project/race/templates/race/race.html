{% extends 'base.html' %}
{% load static %}

{% block title %}ExePLORE - Race{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="{% static 'race/race_styles.css' %}">
{% endblock %}

{% block content %}
<div class="race-page">
    <div class="race-content">
        <div class="race-main">
            <div class="title-bar">{{ race.title }}</div>
            
            <div id="map">
            </div>
            
            <div class="menu">
                <a href="{% url 'race' %}" id="routePOIs">
                    <span>Race Details</span>
                    <i class="fas fa-chevron-right ml-2"></i>
                </a>
                
                <button id="leaderboard">
                    <i class="fas fa-trophy mr-2"></i> Leaderboard
                </button>
                
                <div id="status">
                    {% if race.is_complete %}
                    <p class="status-complete"><i class="fas fa-check-circle mr-2"></i> Completed!</p>
                    {% else %}
                    <p class="status-incomplete"><i class="fas fa-hourglass-half mr-2"></i> Not yet completed</p>
                    {% endif %}
                </div>
                
                <div class="time">
                    {% if race.is_complete %}
                    <p><i class="fas fa-stopwatch mr-2"></i> Personal Best: <strong>{{race.get_duration}}</strong></p>
                    {% else %}
                    <p><i class="fas fa-stopwatch mr-2"></i> Personal Best: Not yet set</p>
                    {% endif %}
                </div>
                
                <div class="actionButtons">
                    <button class="btn-race">
                        <i class="fas fa-running mr-2"></i> RACE!
                    </button>
                    <button class="btn-time-trial">
                        <i class="fas fa-stopwatch mr-2"></i> Time Trial
                    </button>
                    <button class="btn-explore">
                        <i class="fas fa-map-marked-alt mr-2"></i> ExePLORE
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
    const raceData = {
        start: {
            lat: {{ race.start.latitude }},
            lng: {{ race.start.longitude }},
            name: "{{ race.start.name }}"
        },
        end: {
            lat: {{ race.end.latitude }},
            lng: {{ race.end.longitude }},
            name: "{{ race.end.name }}"
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        var map = L.map('map').setView([50.736577, -3.532512], 14.5);  

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        const startIcon = L.divIcon({
            html: '<i class="fa fa-flag fa-3x" style="color: #40ff40;"></i>',
            iconSize: [25, 37],
            iconAnchor: [0, 42],
            popupAnchor: [0, -42], 
            className: 'start-flag-icon'
        });

        const endIcon = L.divIcon({
            html: '<i class="fa fa-flag-checkered fa-3x" style="color: #4040ff;"></i>',
            iconSize: [35, 37],
            iconAnchor: [0, 42],
            popupAnchor: [0, -42],
            className: 'end-flag-icon'
        });

        const startMarker = L.marker([raceData.start.lat, raceData.start.lng], {
            icon: startIcon
        })
            .addTo(map)
            .bindPopup(`Start: ${raceData.start.name}`);

        const endMarker = L.marker([raceData.end.lat, raceData.end.lng], {
            icon: endIcon
        })
            .addTo(map)
            .bindPopup(`End: ${raceData.end.name}`);

        const bounds = L.latLngBounds([
            [raceData.start.lat, raceData.start.lng],
            [raceData.end.lat, raceData.end.lng]
        ]);
        map.fitBounds(bounds, { padding: [50, 50] });
    });

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('leaderboard').addEventListener('click', function() {
            alert('Leaderboard functionality will be implemented soon!');
        });

        const actionButtons = document.querySelectorAll('.actionButtons button');
        actionButtons.forEach(button => {
            button.addEventListener('click', function() {
                if (this.classList.contains('btn-race')) {
                    alert('Race mode selected! Get ready to race!');
                } else if (this.classList.contains('btn-time-trial')) {
                    alert('Time Trial mode selected! Beat your personal best!');
                } else if (this.classList.contains('btn-explore')) {
                    alert('ExePLORE mode selected! Explore at your own pace!');
                }
            });
        });
    });
</script>
{% endblock %}